{"version":3,"file":"operator.js","sources":["../index.js"],"sourcesContent":["import * as m from 'matchit'\n\nconst cache = new Map()\n\nfunction clean (href) {\n  return href.replace(window.location.origin, '')\n}\n\nfunction parse (location, routes) {\n  let hash = ''\n  let search = ''\n  let [ pathname, ...parts ] = location.split(/#|\\?/)\n\n  pathname = pathname.replace(/\\/$/g, '')\n  pathname = pathname || '/'\n\n  for (let i = 0; i < parts.length; i++) {\n    const [ rest ] = location.split(parts[i])\n    if (rest[rest.length - 1] === '?') search = parts[i]\n    if (rest[rest.length - 1] === '#') hash = parts[i]\n  }\n\n  const match = m.match(pathname, routes.map(r => r.matcher))\n  const route = routes.filter(r => r.path === match[0].old)[0]\n\n  return match[0] ? Object.assign({}, route, {\n    params: m.exec(pathname, match),\n    hash,\n    search,\n    pathname,\n    location\n  }) : null\n}\n\nexport default function app (selector, routes = ['*']) {\n  let root = document.querySelector(selector)\n\n  let queue\n  const middleware = []\n  const events = {}\n\n  routes = routes.concat(routes.indexOf('*') < 0 ? '*' : []).reduce((next, r) => {\n    if (typeof r === 'function') {\n      middleware.push(r)\n      return next\n    }\n    return next.concat(r)\n  }, []).map(r => {\n    return r.path ? Object.assign({}, r, {\n      matcher: m.parse(r.path)\n    }) : {\n      path: r,\n      matcher: m.parse(r)\n    }\n  })\n\n  const initialRoute = parse(clean(window.location.href), routes)\n\n  let state = Object.assign({\n    previousDocument: null,\n  }, initialRoute)\n\n  function emit(ev) {\n    return events[ev] ? events[ev].map(fn => fn(state)) : []\n  }\n\n  function done (doc, body, route, pop) {\n    state.previousDocument = doc.cloneNode(true)\n\n    Promise.all(\n      middleware.concat(route.handler || []).map(fn => fn(state))\n    ).then(() => {\n      requestAnimationFrame(() => {\n        root.innerHTML = body\n        emit('after')\n        // after out-transitions\n        route.hash && emit('hash')\n      })\n    })\n  }\n\n  function get (href, route, cb) {\n    if (!route) return window.location.href = href\n\n    fetch(href, { credentials: 'include' })\n      .then(res => res.text())\n      .then(res => {\n        const doc = new window.DOMParser().parseFromString(res, 'text/html')\n        const c = [\n          doc,\n          doc.querySelector(selector).innerHTML\n        ]\n        cache.set(href, c)\n        cb && cb(c[0], c[1], route)\n      })\n  }\n\n  function go (href, route, pop) {\n    queue = () => {\n      const cached = cache.get(href)\n\n      cached && route.cache !== false ? (\n        done(cached[0], cached[1], route, pop)\n      ) : (\n        get(href, route, done)\n      )\n    }\n\n    Object.assign(state, route)\n\n    // allows for redirects\n    Promise.all(emit('before')).then(queue)\n  }\n\n  function match (url) {\n    const href = clean(url)\n    const route = parse(href, routes)\n    return [ href, route ]\n  }\n\n  document.body.addEventListener('click', e => {\n    if (e.ctrlKey || e.metaKey || e.altKey || e.shiftKey || e.defaultPrevented) return\n\n    let a = e.target\n\n    while (a && !(a.href && a.nodeName === 'A')) {\n      a = a.parentNode\n    }\n\n    if (!a) return e\n\n    const [ href, route ] = match(a.href)\n\n    if (route.ignore) return e\n\n    /**\n     * If a hash points to a location on the current page,\n     * update state with the hash, emit the event, and return,\n     * since we don't need to navigate anywhere.\n     */\n    if (state.pathname === route.pathname && route.hash) {\n      e.preventDefault()\n      Object.assign(state, route)\n      emit('hash')\n      return e\n    }\n\n    if (\n      window.location.origin !== a.origin // external link\n      || a.hasAttribute('download')\n      || a.target === '_blank'\n      || /^(?:mailto|tel):/.test(a.href)\n      || a.classList.contains('no-ajax')\n    ) return e\n\n    e.preventDefault()\n\n    state.location !== href && go(href, route, false)\n\n    emit('navigate', state)\n\n    return false\n  })\n\n  window.addEventListener('popstate', e => {\n    if (e.target.location.pathname === state.pathname) return // prevent popstate on hashchange\n    go(...match(e.target.location.href), true)\n    return false\n  })\n\n  return {\n    get state () {\n      return state\n    },\n    go (url) {\n      queue = null\n      go(...match(url), false)\n    },\n    load (href, cb) {\n      return get(...match(href, false), cb)\n    },\n    on (ev, fn) {\n      events[ev] = events[ev] ? events[ev].concat(fn) : [ fn ]\n      return () => events[ev].slice(events[ev].indexOf(fn), 1)\n    }\n  }\n}\n"],"names":["cache","Map","clean","href","replace","window","location","origin","parse","routes","hash","search","split","pathname","parts","i","length","rest","match","m","map","r","matcher","route","filter","path","old","Object","assign","params","selector","queue","root","document","querySelector","middleware","events","concat","indexOf","reduce","next","push","initialRoute","state","previousDocument","emit","ev","fn","done","doc","body","pop","cloneNode","Promise","all","handler","then","requestAnimationFrame","innerHTML","get","cb","fetch","credentials","res","text","DOMParser","parseFromString","c","set","go","cached","url","addEventListener","e","ctrlKey","metaKey","altKey","shiftKey","defaultPrevented","a","target","nodeName","parentNode","ignore","preventDefault","hasAttribute","test","classList","contains","load","on","slice"],"mappings":"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"}